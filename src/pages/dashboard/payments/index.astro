---
export const prerender = false;

import DashboardLayout from "@/layouts/dashboard/layout.astro";
import { setFlashToast } from "@/lib/flash-toast";
import CurrentBalanceCard from "./_/components/current-balance-card.astro";
import PackageCard from "./_/components/package-card.astro";
import PurchaseHistoryTable from "./_/components/purchase-history-table.astro";
import { getCheckoutFlashToast } from "./_/utils/get-checkout-flash-toast.utils";

const PACKAGE_PRICE = 600;
const PACKAGE_CREDITS = 12;
const CLASS_DURATION_MINUTES = 50;

// Handle checkout success and cancel flash toast
const checkoutStatus = Astro.url.searchParams.get("checkout");
if (checkoutStatus === "success" || checkoutStatus === "cancel") {
  setFlashToast(Astro.cookies, getCheckoutFlashToast(checkoutStatus));

  return Astro.redirect("/dashboard/payments");
}

const user = Astro.locals.user!;
---

<DashboardLayout title="Payments & Plans">
  <div class="space-y-8">
    <section class="space-y-2">
      <h1 class="text-2xl font-semibold">Billing & Purchases</h1>
      <p class="text-sm text-muted-foreground">
        Buy your class package and review your Stripe purchase history.
      </p>
    </section>

    <section class="grid gap-4 md:grid-cols-2">
      <PackageCard
        packagePrice={PACKAGE_PRICE}
        packageCredits={PACKAGE_CREDITS}
        classDurationMinutes={CLASS_DURATION_MINUTES}
      />
      <CurrentBalanceCard userId={user.id} />
    </section>
    <PurchaseHistoryTable userId={user.id} />
  </div>
</DashboardLayout>
