---
export const prerender = false;

import { DashboardStripeCheckoutButton } from "@/components/dashboard-stripe-checkout-button";
import DashboardLayout from "@/layouts/dashboard/layout.astro";
import { setFlashToast } from "@/lib/flash-toast";
import { getPaymentsPageData } from "./_/data";
import { formatPurchaseAmount } from "./_/utils/format-purchase-amount.utils";
import { formatPurchaseDate } from "./_/utils/format-purchase-date.utils";
import { getCheckoutFlashToast } from "./_/utils/get-checkout-flash-toast.utils";
import { moneyFormatter } from "./_/utils/money-formatter.utils";

const PACKAGE_PRICE = 600;
const PACKAGE_CREDITS = 12;
const CLASS_DURATION_MINUTES = 50;

// Handle checkout success and cancel flash toast
const checkoutStatus = Astro.url.searchParams.get("checkout");
if (checkoutStatus === "success" || checkoutStatus === "cancel") {
  setFlashToast(Astro.cookies, getCheckoutFlashToast(checkoutStatus));

  return Astro.redirect("/dashboard/payments");
}

const user = Astro.locals.user!;

const { creditBalance, purchases } = await getPaymentsPageData(user.id);
---

<DashboardLayout title="Payments & Plans">
  <div class="space-y-8">
    <section class="space-y-2">
      <h1 class="text-2xl font-semibold">Billing & Purchases</h1>
      <p class="text-sm text-muted-foreground">
        Buy your class package and review your Stripe purchase history.
      </p>
    </section>

    <section class="grid gap-4 md:grid-cols-2">
      <article class="rounded-lg border bg-card p-5">
        <h2 class="text-lg font-semibold">12-Class Package</h2>
        <p class="mt-2 text-sm text-muted-foreground">
          One-time payment. {PACKAGE_CREDITS} credits total, and each credit is one
          {" "}
          {CLASS_DURATION_MINUTES}-minute class.
        </p>
        <p class="mt-4 text-2xl font-bold">
          {moneyFormatter.format(PACKAGE_PRICE)}
        </p>

        <DashboardStripeCheckoutButton
          client:load
          buttonText={`Pay ${moneyFormatter.format(PACKAGE_PRICE)}`}
        />
      </article>

      <article class="rounded-lg border bg-card p-5">
        <h2 class="text-lg font-semibold">Current Balance</h2>
        <p class="mt-2 text-sm text-muted-foreground">
          Credits update automatically after successful Stripe payments.
        </p>
        <p class="mt-4 text-2xl font-bold">{creditBalance} credits</p>
      </article>
    </section>

    <section class="space-y-3">
      <h2 class="text-lg font-semibold">Purchase History</h2>

      {
        purchases.length === 0 ? (
          <p class="rounded-lg border bg-card p-4 text-sm text-muted-foreground">
            No purchases yet.
          </p>
        ) : (
          <div class="overflow-x-auto rounded-lg border bg-card">
            <table class="w-full min-w-[680px] text-sm">
              <thead>
                <tr class="border-b text-left text-muted-foreground">
                  <th class="px-4 py-3 font-medium">Date</th>
                  <th class="px-4 py-3 font-medium">Amount</th>
                  <th class="px-4 py-3 font-medium">Status</th>
                  <th class="px-4 py-3 font-medium">Payment</th>
                  <th class="px-4 py-3 font-medium">Receipt</th>
                </tr>
              </thead>
              <tbody>
                {purchases.map((purchase) => (
                  <tr class="border-b last:border-b-0">
                    <td class="px-4 py-3">
                      {formatPurchaseDate(purchase.created)}
                    </td>
                    <td class="px-4 py-3">
                      {formatPurchaseAmount(
                        purchase.amountTotal,
                        purchase.currency,
                      )}
                    </td>
                    <td class="px-4 py-3 capitalize">
                      {purchase.status ?? "-"}
                    </td>
                    <td class="px-4 py-3 capitalize">
                      {purchase.paymentStatus ?? "-"}
                    </td>
                    <td class="px-4 py-3">
                      {purchase.receiptUrl ? (
                        <a
                          href={purchase.receiptUrl}
                          target="_blank"
                          rel="noreferrer"
                          class="text-primary underline-offset-4 hover:underline"
                        >
                          View receipt
                        </a>
                      ) : (
                        <span class="text-muted-foreground">-</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )
      }
    </section>
  </div>
</DashboardLayout>
