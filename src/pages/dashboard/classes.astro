---
export const prerender = false;

import { and, asc, ClassBooking, db, desc, eq, gte, lt } from "astro:db";
import {
  DashboardMyClassesWidget,
  type MyClassesBookingItem,
} from "@/components/dashboard-my-classes-widget";
import DashboardLayout from "@/layouts/dashboard/layout.astro";

const CANCELLATION_REFUND_WINDOW_HOURS = 24;

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/auth/login");
}

const now = new Date();
const cancellationRefundWindowMs =
  CANCELLATION_REFUND_WINDOW_HOURS * 60 * 60 * 1000;

const upcomingBookedBookingsRaw = await db
  .select({
    id: ClassBooking.id,
    startsAt: ClassBooking.startsAt,
    endsAt: ClassBooking.endsAt,
    status: ClassBooking.status,
  })
  .from(ClassBooking)
  .where(
    and(
      eq(ClassBooking.userId, user.id),
      eq(ClassBooking.status, "booked"),
      gte(ClassBooking.startsAt, now),
    ),
  )
  .orderBy(asc(ClassBooking.startsAt));

const pastBookedBookingsRaw = await db
  .select({
    id: ClassBooking.id,
    startsAt: ClassBooking.startsAt,
    endsAt: ClassBooking.endsAt,
    status: ClassBooking.status,
  })
  .from(ClassBooking)
  .where(
    and(
      eq(ClassBooking.userId, user.id),
      eq(ClassBooking.status, "booked"),
      lt(ClassBooking.startsAt, now),
    ),
  )
  .orderBy(desc(ClassBooking.startsAt));

const cancelledBookingsRaw = await db
  .select({
    id: ClassBooking.id,
    startsAt: ClassBooking.startsAt,
    endsAt: ClassBooking.endsAt,
    status: ClassBooking.status,
  })
  .from(ClassBooking)
  .where(
    and(eq(ClassBooking.userId, user.id), eq(ClassBooking.status, "cancelled")),
  )
  .orderBy(desc(ClassBooking.startsAt));

const dateFormatter = new Intl.DateTimeFormat("en-US", {
  timeZone: "Asia/Seoul",
  weekday: "short",
  year: "numeric",
  month: "short",
  day: "numeric",
});

const timeFormatter = new Intl.DateTimeFormat("en-US", {
  timeZone: "Asia/Seoul",
  hour: "numeric",
  minute: "2-digit",
});

function toBookingItem(booking: {
  id: string;
  status: "booked" | "cancelled";
  startsAt: Date;
  endsAt: Date;
}): MyClassesBookingItem {
  const startsAtDate = new Date(booking.startsAt);
  const endsAtDate = new Date(booking.endsAt);
  const canCancel =
    booking.status === "booked" && startsAtDate.getTime() > now.getTime();
  const isRefundEligible =
    canCancel &&
    startsAtDate.getTime() - now.getTime() >= cancellationRefundWindowMs;

  return {
    id: booking.id,
    status: booking.status,
    startsAtIso: startsAtDate.toISOString(),
    endsAtIso: endsAtDate.toISOString(),
    kstDateLabel: dateFormatter.format(startsAtDate),
    kstTimeRangeLabel: `${timeFormatter.format(startsAtDate)} - ${timeFormatter.format(endsAtDate)}`,
    canCancel,
    isRefundEligible,
  };
}

const upcomingBookings = upcomingBookedBookingsRaw.map(toBookingItem);
const nextClass = upcomingBookings[0] ?? null;
const upcomingBookingsWithoutNextClass = nextClass
  ? upcomingBookings.filter((booking) => booking.id !== nextClass.id)
  : upcomingBookings;
const cancelledBookings = cancelledBookingsRaw.map(toBookingItem);
const pastBookings = pastBookedBookingsRaw.map(toBookingItem);
---

<DashboardLayout title="My Classes">
  <div class="space-y-6">
    <section class="space-y-2">
      <h1 class="text-2xl font-semibold">My Classes</h1>
      <p class="text-sm text-muted-foreground">
        View your upcoming and past classes. All times are shown in KST.
      </p>
      <p class="text-sm text-muted-foreground">
        Full refund if canceled at least {CANCELLATION_REFUND_WINDOW_HOURS} hours
        before class start.
      </p>
    </section>

    <DashboardMyClassesWidget
      client:load
      nextClass={nextClass}
      upcomingBookings={upcomingBookingsWithoutNextClass}
      cancelledBookings={cancelledBookings}
      pastBookings={pastBookings}
      refundWindowHours={CANCELLATION_REFUND_WINDOW_HOURS}
    />
  </div>
</DashboardLayout>
