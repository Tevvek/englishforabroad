---
import { getNextUpcomingBooking } from "../queries/get-next-upcoming-booking.query";
import { formatKstDate } from "../utils/format-kst-date.utils";
import { formatKstTime } from "../utils/format-kst-time.utils";

interface Props {
  userId: string;
  creditBalance: number;
}

const { userId, creditBalance } = Astro.props;

const now = new Date();
const nextClass = await getNextUpcomingBooking(userId, now);

const nextClassDateLabel = nextClass ? formatKstDate(nextClass.startsAt) : null;
const nextClassTimeRangeLabel = nextClass
  ? `${formatKstTime(nextClass.startsAt)} - ${formatKstTime(nextClass.endsAt)}`
  : null;
---

<section class="rounded-lg border bg-card p-5">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div class="space-y-1">
      <h2 class="text-lg font-semibold">Next Class</h2>
      {
        nextClassDateLabel ? (
          <p class="text-sm text-muted-foreground">
            {nextClassDateLabel} at {nextClassTimeRangeLabel} (KST)
          </p>
        ) : (
          <p class="text-sm text-muted-foreground">
            You do not have a booked class yet. Pick a time to get started.
          </p>
        )
      }
    </div>

    <a
      href={nextClass ? "/dashboard/classes" : "/dashboard/book"}
      class="inline-flex h-9 items-center justify-center rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90"
    >
      {nextClass ? "Go to My Classes" : "Book a Class"}
    </a>
  </div>

  {
    creditBalance < 1 && (
      <p class="mt-3 rounded-md border border-amber-300/50 bg-amber-50/80 px-3 py-2 text-sm text-amber-900">
        You have no credits left. Buy a package to book more classes.
      </p>
    )
  }
</section>
