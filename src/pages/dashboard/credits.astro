---
export const prerender = false;

import { db, desc, eq, CreditLedger } from "astro:db";
import DashboardLayout from "@/layouts/dashboard/layout.astro";

const CLASS_DURATION_MINUTES = 50;

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/auth/login");
}

const ledgerEntries = await db
  .select()
  .from(CreditLedger)
  .where(eq(CreditLedger.userId, user.id))
  .orderBy(desc(CreditLedger.createdAt));

const creditsSummary = ledgerEntries.reduce(
  (summary, entry) => {
    const delta = entry.creditsDelta;

    summary.currentBalance += delta;

    if (delta > 0) {
      summary.totalGranted += delta;
    } else if (delta < 0) {
      summary.totalUsed += Math.abs(delta);
    }

    return summary;
  },
  { currentBalance: 0, totalGranted: 0, totalUsed: 0 },
);

const dateFormatter = new Intl.DateTimeFormat("en-US", {
  dateStyle: "medium",
  timeStyle: "short",
});

const entryTypeLabels: Record<string, string> = {
  purchase_grant: "Package purchase",
  booking_deduct: "Class booked",
  booking_refund: "Class refunded",
  manual_adjustment: "Manual adjustment",
};

function formatEntryType(entryType: string) {
  return entryTypeLabels[entryType] ?? entryType;
}

function formatCreditsDelta(creditsDelta: number) {
  return creditsDelta > 0 ? `+${creditsDelta}` : `${creditsDelta}`;
}

function formatEntryDate(date: Date) {
  return dateFormatter.format(new Date(date));
}
---

<DashboardLayout title="Credits & Usage">
  <div class="space-y-8">
    <section class="space-y-2">
      <h1 class="text-2xl font-semibold">Credits & Usage</h1>
      <p class="text-sm text-muted-foreground">
        Track your available class credits and usage history.
      </p>
    </section>

    <section class="grid gap-4 md:grid-cols-3">
      <article class="rounded-lg border bg-card p-5">
        <h2 class="text-lg font-semibold">Current Balance</h2>
        <p class="mt-2 text-sm text-muted-foreground">Available to book now.</p>
        <p class="mt-4 text-2xl font-bold">
          {creditsSummary.currentBalance} credits
        </p>
      </article>

      <article class="rounded-lg border bg-card p-5">
        <h2 class="text-lg font-semibold">Total Granted</h2>
        <p class="mt-2 text-sm text-muted-foreground">
          Purchased or refunded credits.
        </p>
        <p class="mt-4 text-2xl font-bold">
          {creditsSummary.totalGranted} credits
        </p>
      </article>

      <article class="rounded-lg border bg-card p-5">
        <h2 class="text-lg font-semibold">Total Used</h2>
        <p class="mt-2 text-sm text-muted-foreground">
          Credits consumed by bookings.
        </p>
        <p class="mt-4 text-2xl font-bold">
          {creditsSummary.totalUsed} credits
        </p>
      </article>
    </section>

    <p class="text-sm text-muted-foreground">
      1 credit = 1 class ({CLASS_DURATION_MINUTES} minutes)
    </p>

    <section class="space-y-3">
      <h2 class="text-lg font-semibold">Credit Activity</h2>

      {
        ledgerEntries.length === 0 ? (
          <p class="rounded-lg border bg-card p-4 text-sm text-muted-foreground">
            No credit activity yet.
          </p>
        ) : (
          <div class="overflow-x-auto rounded-lg border bg-card">
            <table class="w-full min-w-[680px] text-sm">
              <thead>
                <tr class="border-b text-left text-muted-foreground">
                  <th class="px-4 py-3 font-medium">Date</th>
                  <th class="px-4 py-3 font-medium">Type</th>
                  <th class="px-4 py-3 font-medium">Delta</th>
                  <th class="px-4 py-3 font-medium">Description</th>
                </tr>
              </thead>
              <tbody>
                {ledgerEntries.map((entry) => (
                  <tr class="border-b last:border-b-0">
                    <td class="px-4 py-3">
                      {formatEntryDate(entry.createdAt)}
                    </td>
                    <td class="px-4 py-3">
                      {formatEntryType(entry.entryType)}
                    </td>
                    <td
                      class:list={[
                        "px-4 py-3 font-medium",
                        entry.creditsDelta > 0
                          ? "text-emerald-600"
                          : entry.creditsDelta < 0
                            ? "text-rose-600"
                            : "",
                      ]}
                    >
                      {formatCreditsDelta(entry.creditsDelta)}
                    </td>
                    <td class="px-4 py-3 text-muted-foreground">
                      {entry.description ?? "-"}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )
      }
    </section>
  </div>
</DashboardLayout>
